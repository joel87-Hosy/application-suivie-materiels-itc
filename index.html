<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ITC Telecom ERP | Automation & Stock Expert</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        @media (max-width: 1024px) { .sidebar-hidden { transform: translateX(-100%); } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ec4899; border-radius: 10px; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800 overflow-hidden uppercase italic font-bold text-[10px]">
    <audio id="beep-sound" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" preload="auto"></audio>
    <div id="qrcode-temp" style="display:none;"></div>
    <div id="login-screen" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-[100]">
        <div class="bg-white p-10 rounded-3xl shadow-2xl max-w-md w-full mx-4 text-center border-t-4 border-pink-500">
            <img src="logo-ITC-NW-01-fond-blanc-01.jpg" alt="Logo ITC" class="h-20 mx-auto mb-4" />
            <h2 class="text-xl font-black text-slate-900 mb-8 tracking-tighter italic">SÉCURITÉ ERP GLOBAL</h2>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input id="login-email" type="email" placeholder="EMAIL PROFESSIONNEL" class="w-full border-2 p-3 rounded-xl text-xs uppercase outline-none" required />
                <input id="login-password" type="password" placeholder="MOT DE PASSE" class="w-full border-2 p-3 rounded-xl text-xs outline-none" required />
                <button type="submit" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl tracking-widest text-[10px] hover:bg-indigo-700 transition shadow-lg">AUTHENTIFICATION</button>
                <p onclick="resetPassword()" class="text-[9px] text-center text-indigo-600 cursor-pointer mt-4 hover:underline italic">
                    Mot de passe oublié ?
                </p>
            </form>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-40 hidden lg:hidden"></div>
        <div class="flex h-screen overflow-hidden">
            <aside id="sidebar" class="fixed lg:relative w-72 bg-slate-900 text-white h-full z-50 sidebar-transition sidebar-hidden lg:transform-none shadow-2xl flex flex-col">
                <div class="p-4 bg-white border-b border-slate-800 flex flex-col items-center shrink-0">
                    <img src="logo-ITC-NW-01-fond-blanc-01.jpg" alt="Logo ITC" class="h-16 lg:h-20 object-contain" />
                </div>
                <nav class="flex-1 mt-4 overflow-y-auto custom-scrollbar pb-10">
                    <div id="menu-cockpit" onclick="showSection('cockpit'); toggleSidebarMobile();" class="cursor-pointer py-3 px-6 flex items-center hover:bg-slate-800 transition">
                        <i class="fas fa-chart-line w-6 text-pink-500"></i><span class="ml-2">Tableau de Bord</span>
                    </div>

                    <div id="menu-superviseur" class="mt-6 hidden">
                        <p class="px-6 text-[10px] text-slate-500 mb-2 uppercase opacity-50">Contrôle</p>
                        <div onclick="showSection('trafic-audit'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition italic">
                            <i class="fas fa-exchange-alt w-5 text-blue-400"></i> Journal d'Audit <span id="notif-superviseur" class="notification-badge hidden">0</span>
                            <div onclick="showSection('stats-consommation'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition italic font-black text-green-400">
                                <i class="fas fa-chart-pie w-5"></i> Stats Consommation
                            </div>
                        </div>
                    </div>

                    <div id="menu-technicien" class="mt-6 hidden">
                        <p class="px-6 text-[10px] text-slate-500 mb-2 uppercase opacity-50">Opérations Terrain</p>
                        <div onclick="showSection('tech-nouvelle-demande'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition italic"><i class="fas fa-plus-circle w-5 text-green-500"></i> Demander Matériel</div>
                        <div onclick="showSection('tech-retour-materiel'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition italic"><i class="fas fa-undo w-5 text-orange-400"></i> Retour de Stock</div>
                        <div onclick="showSection('tech-mes-demandes'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition relative italic"><i class="fas fa-file-download w-5 text-pink-500"></i> Mes Bons <span id="notif-tech" class="notification-badge hidden">0</span></div>
                    </div>

                    <div id="menu-coordinatrice" class="mt-6 hidden">
                        <p class="px-6 text-[10px] text-slate-500 mb-2 uppercase opacity-50">Gestion Flux</p>
                        <div onclick="showSection('coord-demandes-tech'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition relative italic"><i class="fas fa-inbox w-5 text-orange-500"></i> Flux Tech <span id="notif-coord" class="notification-badge hidden">0</span></div>
                        <div onclick="showSection('coord-creation-directe'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition italic"><i class="fas fa-plus-square w-5 text-pink-400"></i> Commande Directe</div>
                        <div onclick="showSection('coord-excel'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition italic"><i class="fas fa-file-excel w-5 text-green-400"></i> Commande via Excel</div>
                    </div>

                    <div id="menu-gestionnaire" class="mt-6 hidden">
                        <p class="px-6 text-[10px] text-slate-500 uppercase mb-2 opacity-50">Magasin</p>
                        <div onclick="showSection('demandes-coordonnatrice'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition relative italic"><i class="fas fa-envelope-open-text w-5 text-yellow-500"></i> Commandes <span id="notif-gest-coord" class="notification-badge hidden">0</span></div>
                        <div onclick="showSection('reception'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition italic"><i class="fas fa-download w-5 text-green-400"></i> Entrée Stock</div>
                        <div onclick="showSection('livraison'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition italic"><i class="fas fa-truck-loading w-5 text-indigo-400"></i> Sortie Physique</div>
                        <div onclick="showSection('gestion-retours'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition italic"><i class="fas fa-undo-alt w-5 text-orange-500"></i> Valider Retours</div>
                        <div onclick="showSection('scanner-physique'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition italic font-black text-pink-400 border-l-2 border-pink-500 ml-2 mt-1">
                          <i class="fas fa-qrcode w-5"></i> Scanner Bon (Cam)
                      </div>
                    </div>
                    
                    <div id="section-stock-disponible" class="mt-6 border-t border-slate-800 pt-4">
                        <p class="px-6 text-[10px] text-slate-500 uppercase mb-2 opacity-50">Consultation Stock</p>
                        <div onclick="showSection('stock-itc'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition italic"><i class="fas fa-box w-5 text-indigo-400"></i> STOCK ITC</div>
                        <div onclick="showSection('stock-oci-cic'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition italic"><i class="fas fa-box w-5 text-green-400"></i> OCI-CIC</div>
                        <div onclick="showSection('stock-moov'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition italic"><i class="fas fa-box w-5 text-yellow-400"></i> MOOV</div>
                        <div onclick="showSection('stock-mtn'); toggleSidebarMobile();" class="cursor-pointer py-2 px-8 hover:text-white flex items-center transition italic"><i class="fas fa-box w-5 text-red-400"></i> MTN</div>
                    </div>
                    
                </nav>
                <div class="p-4 border-t border-slate-800"><button onclick="logout()" class="w-full bg-red-600 text-white py-2 rounded-xl text-xs font-black uppercase hover:bg-red-700 transition">Déconnexion</button></div>
            </aside>

            <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
                <header class="h-16 bg-white border-b flex items-center justify-between px-8 shadow-sm shrink-0 font-black italic">
                    <div class="flex items-center">
                        <button onclick="toggleSidebar()" class="lg:hidden mr-4 text-slate-600 text-xl p-2 rounded-md hover:bg-slate-100 transition"><i class="fas fa-bars"></i></button>
                        <h2 id="view-title" class="font-black text-slate-500 tracking-widest uppercase italic text-[10px]">ERP DASHBOARD</h2>
                    </div>
                    <div class="text-right">
                        <p id="user-role-badge" class="text-[8px] font-black text-white bg-pink-600 px-2 py-0.5 rounded uppercase mb-1">RÔLE</p>
                        <p id="user-name" class="text-slate-800 italic">UTILISATEUR</p>
                    </div>
                </header>
                <div id="app-container" class="p-8 overflow-y-auto flex-1 h-full"></div>
            </main>
        </div>
    </div>

    <script>
        let currentSectionId = "cockpit"; // Par défaut on est sur le cockpit
// CONFIGURATION FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyD7P-6vY3yHQx7OFCs6th6gN6EURP89QUQ",
    authDomain: "itc-erp.firebaseapp.com",
    databaseURL: "https://itc-erp-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "itc-erp",
    storageBucket: "itc-erp.firebasestorage.app",
    messagingSenderId: "870100539481",
    appId: "1:870100539481:web:e12d817a9a44e867e97948",
    measurementId: "G-HMRDVGSWHM"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// L'unique déclaration de currentUser pour toute l'app
let currentUser = null; 
let appData = {
    stock: [], demandes: [], techDemandes: [], retours: [],
    notifications: [], scansDuJour: [], derniereDateScan: null,
    users: [
        { id: 1, name: "AHONON ROGER", role: "Superviseur", email: "roger.ahonon@itc.ci" },
        { id: 2, name: "GESTIONNAIRE", role: "Gestionnaire", email: "gest@itc.ci" },
        { id: 7, name: "COORDINATRICE", role: "Coordinatrice", email: "coord@itc.ci" },
        { id: 8, name: "TECHNICIEN TERRAIN", role: "Technicien", email: "tech@itc.ci" }
    ]
};
// Écoute en temps réel des changements sur Firebase
// Écoute en temps réel des changements sur Firebase
db.ref('itc_data').on('value', (snapshot) => {
    const data = snapshot.val();
    
    // On vérifie que les données existent et que l'utilisateur est connecté
    if (data && currentUser) {
        appData = data; // Mise à jour de la mémoire locale
        updateNotifications(); // Met à jour les petites pastilles rouges
        
        const container = document.getElementById("app-container");

        // --- LOGIQUE DE RAFRAÎCHISSEMENT INTELLIGENT ---
        // On ne redessine que la section que l'utilisateur est en train de regarder
        
        if (currentSectionId === "cockpit") {
            renderCockpit(container);
        } 
        else if (currentSectionId === "stats-consommation") {
            renderStatsConsommation(container); // <--- AJOUTÉ : Pour que les stats s'actualisent
        } 
        else if (currentSectionId === "trafic-audit") {
            renderTraficAudit(container);
        }
        else if (currentSectionId === "coord-demandes-tech") {
            renderCoordFluxTech(container); // <--- AJOUTÉ : Pour la coordinatrice
        }
        else if (currentSectionId === "demandes-coordonnatrice") {
            renderDemandesGestionnaire(container); // <--- AJOUTÉ : Pour le magasinier
        }
        else if (currentSectionId === "tech-mes-demandes") {
            renderTechMesDemandes(container); // <--- AJOUTÉ : Pour le technicien
        }
        else if (currentSectionId === "livraison") {
            renderLivraisonForm(container);
        }
        else if (currentSectionId === "gestion-retours") {
            renderGestionRetours(container);
        }
        else if (currentSectionId.startsWith("stock-")) {
            renderStock(currentSectionId.replace("stock-", ""), container);
        }
        
        console.log("Mise à jour temps réel appliquée sur : " + currentSectionId);
    }
});
function save() {
    db.ref('itc_data').set(appData);
}
    
    // On garde quand même une copie locale par sécurité
    localStorage.setItem("itc_erp_v6_qr", JSON.stringify(appData));


        // --- AUTH ---
        async function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById("login-email").value.toLowerCase().trim();
    const password = document.getElementById("login-password").value.trim();

    try {
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        const userProfile = appData.users.find(u => u.email === email);
        
        if (userProfile) {
            currentUser = userProfile;
            document.getElementById("login-screen").classList.add("hidden");
            document.getElementById("main-app").classList.remove("hidden");
            
            updateMenuVisibility();
            updateUserInfo();
            updateNotifications();
            
            // Redirection intelligente
            showSection(currentUser.role === 'Technicien' ? "tech-nouvelle-demande" : "cockpit");
        }
    } catch (error) {
        alert("ÉCHEC D'AUTHENTIFICATION : " + error.message);
    }
}

// Persistance de la session
firebase.auth().onAuthStateChanged((user) => {
    if (user) {
        // 1. Sécurité : On vérifie que les données de l'application sont bien chargées
        if (!appData || !appData.users) {
            console.warn("Attente du chargement des données ITC...");
            // On peut forcer un petit délai ou attendre le prochain cycle du listener
            return; 
        }

        // 2. Recherche du profil avec sécurité sur l'email
        const profile = appData.users.find(u => u.email.toLowerCase() === user.email.toLowerCase());

        if (profile) {
            currentUser = profile;
            
            // 3. Mise à jour de l'interface
            document.getElementById("login-screen").classList.add("hidden");
            document.getElementById("main-app").classList.remove("hidden");
            
            // 4. Initialisation des composants
            updateMenuVisibility(); 
            updateUserInfo(); 
            updateNotifications();
            
            // 5. Affichage de la section par défaut (Cockpit)
            showSection("cockpit");
            
            console.log("Utilisateur ITC connecté : " + currentUser.nom);
        } else {
            console.error("Profil introuvable pour cet email : " + user.email);
            // Optionnel : déconnecter si l'email n'est pas autorisé dans l'ERP
            // firebase.auth().signOut();
        }
    } else {
        // Gestion de la déconnexion : on affiche le login
        document.getElementById("login-screen").classList.remove("hidden");
        document.getElementById("main-app").classList.add("hidden");
        currentUser = null;
    }
});
function logout() {
    // 1. Déconnexion de Firebase Auth
    firebase.auth().signOut().then(() => {
        // 2. Nettoyage des données locales
        appData.currentUserId = null;
        currentUser = null;
        
        // 3. Optionnel : Nettoyer le localStorage si tu l'utilises pour le backup
        localStorage.removeItem("itc_erp_local_backup");

        // 4. Redirection forcée vers le login (sans recharger forcément toute la page)
        document.getElementById("main-app").classList.add("hidden");
        document.getElementById("login-screen").classList.remove("hidden");
        
        console.log("Déconnexion réussie.");
    }).catch((error) => {
        console.error("Erreur lors de la déconnexion :", error);
    });
}
        function resetPassword() {
    const email = document.getElementById("login-email").value.trim();

    if (!email) {
        alert("Veuillez d'abord saisir votre adresse email dans le champ ci-dessus.");
        return;
    }

    firebase.auth().sendPasswordResetEmail(email)
        .then(() => {
            alert("Un email de réinitialisation a été envoyé à : " + email + ". Vérifiez vos courriers indésirables (spams).");
        })
        .catch((error) => {
            console.error(error);
            alert("Erreur : " + error.message);
        });
}

        function updateMenuVisibility() {
            const r = currentUser.role;
            document.getElementById("menu-superviseur").classList.toggle("hidden", r !== "Superviseur");
            document.getElementById("menu-technicien").classList.toggle("hidden", r !== "Technicien");
            document.getElementById("menu-coordinatrice").classList.toggle("hidden", r !== "Coordinatrice");
            document.getElementById("menu-gestionnaire").classList.toggle("hidden", r !== "Gestionnaire");
            document.getElementById("section-stock-disponible").classList.toggle("hidden", r === "Technicien");
            document.getElementById("menu-cockpit").classList.toggle("hidden", r === "Technicien");
        }
        function updateUserInfo() {
            document.getElementById("user-name").innerText = currentUser.name;
            document.getElementById("user-role-badge").innerText = currentUser.role.toUpperCase();
        }
        function toggleSidebar() { document.getElementById("sidebar").classList.toggle("sidebar-hidden"); document.getElementById("sidebar-overlay").classList.toggle("hidden"); }
        function toggleSidebarMobile() { if (window.innerWidth < 1024) toggleSidebar(); }

        function verifierReinitialisationQuotidienne() {
    const aujourdhui = new Date().toLocaleDateString();
    if (appData.derniereDateScan !== aujourdhui) {
        appData.scansDuJour = []; // On vide l'historique
        appData.derniereDateScan = aujourdhui; // On met à jour la date
        save();
    }
}

function renderStatsConsommation(container) {
    const moisActuel = new Date().getMonth();
    const anneeActuelle = new Date().getFullYear();

    // 1. Filtrer les bons livrés ce mois-ci
    const livraisonsMois = appData.demandes.filter(d => {
        if (d.status !== "LIVREE" || !d.dateLivraison) return false;
        const [jour, mois, annee] = d.dateLivraison.split('/');
        return (parseInt(mois) - 1) === moisActuel && parseInt(annee) === anneeActuelle;
    });

    // 2. Calculer par Technicien et par Équipe
    const statsTech = {};
    const statsEquipe = {};

    livraisonsMois.forEach(d => {
        const nom = d.demandeurName;
        const equipe = d.prestataire || "SANS ÉQUIPE";
        const totalItems = d.items.reduce((sum, i) => sum + i.qty, 0);

        statsTech[nom] = (statsTech[nom] || 0) + totalItems;
        statsEquipe[equipe] = (statsEquipe[equipe] || 0) + totalItems;
    });

    // 3. Interface visuelle
    container.innerHTML = `
    <div class="space-y-8">
        <h3 class="text-xl font-black uppercase text-indigo-900 border-b-4 border-indigo-600 pb-2 italic">
            Rapport de Consommation - ${new Date().toLocaleString('fr-FR', { month: 'long', year: 'numeric' })}
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-3xl shadow-xl">
                <h4 class="text-indigo-600 mb-4 uppercase font-black border-b pb-2 text-[9px]">Top Consommation par Équipe (Unités)</h4>
                <div class="space-y-4">
                    ${Object.entries(statsEquipe).sort((a,b) => b[1] - a[1]).map(([eq, val]) => `
                        <div>
                            <div class="flex justify-between text-[9px] mb-1"><span>${eq}</span><span class="font-black">${val} U</span></div>
                            <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                <div class="bg-indigo-500 h-full" style="width: ${Math.min(val, 100)}%"></div>
                            </div>
                        </div>
                    `).join("") || '<p class="text-[8px] text-slate-400">Aucune donnée ce mois-ci</p>'}
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-xl">
                <h4 class="text-pink-600 mb-4 uppercase font-black border-b pb-2 text-[9px]">Consommation par Technicien</h4>
                <div class="space-y-3">
                    ${Object.entries(statsTech).sort((a,b) => b[1] - a[1]).map(([nom, val]) => `
                        <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border-l-4 border-pink-500">
                            <span class="text-[9px] font-black">${nom}</span>
                            <span class="bg-pink-100 text-pink-700 px-3 py-1 rounded-lg text-[8px] font-black">${val} ARTICLES</span>
                        </div>
                    `).join("") || '<p class="text-[8px] text-slate-400">Aucune donnée</p>'}
                </div>
            </div>
        </div>
        
        <div class="flex gap-4">
            <button onclick="window.print()" class="bg-slate-900 text-white px-6 py-3 rounded-xl text-[8px] font-black uppercase shadow-lg">
                <i class="fas fa-print mr-2"></i> Imprimer le rapport mensuel
            </button>

            <button onclick="exportStatsToExcel()" class="bg-green-600 text-white px-6 py-3 rounded-xl text-[8px] font-black uppercase shadow-lg">
                <i class="fas fa-file-excel mr-2"></i> Exporter en Excel (.xlsx)
            </button>
        </div>
    </div>`;
} // <--- C'est cette accolade qui manquait !

        // --- SECTION ROUTER ---
        function showSection(id) {
    // 1. MISE À JOUR DE LA VARIABLE GLOBALE (Crucial pour le rafraîchissement Firebase)
    // Assure-toi que cette variable s'appelle BIEN 'currentSectionId' partout dans ton script
    currentSectionId = id; 

    const container = document.getElementById("app-container");
    const viewTitle = document.getElementById("view-title");

    // 2. MISE À JOUR DU TITRE DE L'EN-TÊTE
    viewTitle.innerText = id.toUpperCase().replace(/-/g, " ");

    // 3. NETTOYAGE DE L'ÉCRAN (Évite les superpositions)
    container.innerHTML = "";

    // 4. AIGUILLAGE LOGIQUE (Mapping complet de l'ERP)
    if (id === "cockpit") {
        renderCockpit(container);
    } 
    else if (id === "stats-consommation") {
        renderStatsConsommation(container);
    } 
    else if (id === "trafic-audit") {
        renderTraficAudit(container);
    }
    else if (id === "tech-nouvelle-demande") {
        renderTechDemandeForm(container);
    } 
    else if (id === "tech-mes-demandes") {
        renderTechMesDemandes(container);
    } 
    else if (id === "tech-retour-materiel") {
        renderRetourForm(container);
    } 
    else if (id === "coord-demandes-tech") {
        renderCoordFluxTech(container);
    } 
    else if (id === "coord-creation-directe") {
        renderCoordCreationDirecte(container);
    } 
    else if (id === "coord-excel") {
        renderCoordExcelUpload(container);
    } 
    else if (id === "demandes-coordonnatrice") {
        renderDemandesGestionnaire(container);
    } 
    else if (id === "reception") {
        renderReceptionForm(container);
    }
    else if (id === "livraison") {
        renderLivraisonForm(container);
    } 
    else if (id === "gestion-retours") {
        renderGestionRetours(container);
    } 
    else if (id === "scanner-physique") {
        renderScanner(container);
    }
    else if (id.startsWith("stock-")) {
        renderStock(id.replace("stock-", ""), container);
    }
    else {
        // Sécurité si un ID est mal orthographié dans le HTML
        container.innerHTML = `<div class="p-10 text-center opacity-50 uppercase font-black">Section "${id}" en cours de déploiement...</div>`;
    }

    // 5. GESTION DES NOTIFICATIONS (Marquer comme lu)
    const sectionsANotifs = ["coord-demandes-tech", "demandes-coordonnatrice", "tech-mes-demandes", "coord-excel", "trafic-audit"];
    if (sectionsANotifs.includes(id)) {
        markNotificationsAsRead();
    }
}
        // --- AUTOMATISATION EXCEL (COORDINATRICE) ---
        function renderCoordExcelUpload(container) {
            container.innerHTML = `
                <div class="max-w-2xl mx-auto bg-white p-10 rounded-3xl shadow-xl text-center">
                    <i class="fas fa-file-excel text-6xl text-green-600 mb-6"></i>
                    <h3 class="text-xl mb-4 font-black italic">Importer une liste de matériel</h3>
                    <p class="text-slate-400 mb-8 text-[9px] uppercase">Colonnes attendues : "Désignation" et "Quantité"</p>
                    <input type="file" id="excel-file" accept=".xlsx, .xls" class="hidden" onchange="processExcel(event)" />
                    <button onclick="document.getElementById('excel-file').click()" class="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-black uppercase text-[10px] shadow-lg hover:bg-indigo-700">Sélectionner le fichier Excel</button>
                </div>`;
        }

        function processExcel(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(evt) {
                const data = evt.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                renderExcelOrderForm(rows);
            };
            reader.readAsBinaryString(file);
        }

        function renderExcelOrderForm(items) {
            const container = document.getElementById("app-container");
            container.innerHTML = `
                <div class="max-w-4xl mx-auto bg-white p-10 rounded-3xl shadow-xl italic font-bold">
                    <h3 class="mb-8 border-b-4 border-indigo-600 pb-2 text-indigo-900 uppercase font-black italic">Formulaire de Commande via Excel</h3>
                    <form onsubmit="handleExcelSubmit(event)" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-50 p-6 rounded-2xl border-2">
                            <div><label class="text-[8px] text-slate-400">OPÉRATEUR SOURCE</label><input id="ex-op" type="text" value="ITC" class="w-full border-2 p-3 rounded-xl text-xs uppercase font-black bg-slate-100" readonly /></div>
                            <div><label class="text-[8px] text-slate-400">CHEF D'ÉQUIPE</label><input id="ex-chef" type="text" class="w-full border-2 p-3 rounded-xl text-xs uppercase" placeholder="NOM DU CHEF" required /></div>
                            <div><label class="text-[8px] text-slate-400">NOM DE L'ÉQUIPE</label><input id="ex-team" type="text" class="w-full border-2 p-3 rounded-xl text-xs uppercase" placeholder="NOM DE L'ÉQUIPE" required /></div>
                            <div><label class="text-[8px] text-slate-400">MOTIF & LIEU D'INTERVENTION</label><input id="ex-motif" type="text" class="w-full border-2 p-3 rounded-xl text-xs uppercase" placeholder="MOTIF ET LIEU" required /></div>
                        </div>

                        <div class="space-y-3" id="excel-items-list">
                            <p class="text-[9px] text-indigo-600 mb-2 uppercase font-black">Matériel à valider ou modifier :</p>
                            ${items.map(it => `
                                <div class="flex gap-2 items-center art-row-ex bg-slate-50 p-2 rounded-xl border transition hover:border-indigo-300">
                                    <input type="text" value="${it.Désignation || it.Article || ''}" class="w-3/4 border p-2 rounded-lg text-[9px] art-l uppercase bg-white" required />
                                    <input type="number" value="${it.Quantité || it.Qté || 0}" class="w-1/4 border p-2 rounded-lg text-[9px] art-q" required min="1" />
                                    <button type="button" onclick="this.parentElement.remove()" class="text-red-500 p-2"><i class="fas fa-trash"></i></button>
                                </div>
                            `).join("")}
                        </div>

                        <div class="flex gap-4">
                            <button type="button" onclick="addRowEx()" class="bg-slate-200 text-slate-700 px-6 py-3 rounded-xl text-[9px] uppercase font-black">+ Ajouter matériel</button>
                            <button type="submit" class="flex-1 bg-indigo-600 text-white py-4 rounded-xl text-[10px] font-black uppercase shadow-lg hover:bg-black transition">Soumettre au Gestionnaire</button>
                        </div>
                    </form>
                </div>`;
        }

        function renderScanner(container) {
    // Vérification de la date à l'ouverture du scanner
    verifierReinitialisationQuotidienne();

    // --- MODIFICATION AJOUTÉE ICI ---
    // 1. Sécurité : On s'assure que appData existe
    if (!appData) return; 

    // 2. On récupère la liste des demandes de manière sécurisée
    const demandes = appData.demandes || [];

    // 3. Si aucune demande n'existe, on affiche un message et ON ARRÊTE LÀ (return)
    // Cela évite de lancer la caméra inutilement.
    if (demandes.length === 0) {
        container.innerHTML = `<p class="p-10 text-center opacity-50 uppercase font-black">Aucune donnée à scanner pour le moment</p>`;
        return;
    }
    // --------------------------------

    container.innerHTML = `
        <div class="max-w-md mx-auto space-y-4">
            <div class="bg-white p-6 rounded-3xl shadow-xl text-center">
                <h3 class="mb-4 uppercase text-pink-600 font-black italic">Scanner de Bons ITC</h3>
                <div id="reader" class="rounded-2xl overflow-hidden border-4 border-slate-100 bg-black"></div>
                <div class="flex justify-center gap-4 mt-4">
                    <button id="torch-button" class="bg-yellow-400 text-slate-900 px-4 py-2 rounded-xl text-[8px] font-black uppercase">
                        <i class="fas fa-lightbulb"></i> Lampe
                    </button>
                </div>
                <div id="scanner-result" class="mt-4 p-4 hidden bg-green-50 rounded-xl border border-green-200">
                    <p class="text-[9px] text-green-700 font-black italic uppercase" id="scan-id-text"></p>
                </div>
            </div>

            <div class="bg-slate-900 text-white p-6 rounded-3xl shadow-xl">
                <div class="flex justify-between items-center border-b border-slate-700 pb-2 mb-4">
                    <h4 class="text-[9px] font-black uppercase italic text-slate-400">Scans du jour</h4>
                    <span class="text-[8px] bg-slate-700 px-2 py-0.5 rounded">${new Date().toLocaleDateString()}</span>
                </div>
                <div class="space-y-3 max-h-40 overflow-y-auto custom-scrollbar">
                    ${ 
                        // J'ai aussi ajouté la sécurité (|| []) ici pour éviter une autre erreur potentielle
                        (appData.scansDuJour || []).length === 0 ? 
                        '<p class="text-center py-4 text-slate-600 text-[8px] uppercase">Aucun scan aujourd\'hui</p>' : 
                        (appData.scansDuJour || []).map(s => `
                            <div class="flex justify-between items-center bg-slate-800 p-3 rounded-xl border-l-2 border-pink-500">
                                <div>
                                    <p class="text-pink-400 text-[9px] font-black">${s.id}</p>
                                    <p class="text-[7px] text-slate-400 uppercase">${s.technicien}</p>
                                </div>
                                <span class="text-[8px] font-black text-slate-500">${s.heure}</span>
                            </div>
                        `).join("")
                    }
                </div>
            </div>

            <button onclick="showSection('cockpit')" class="w-full text-slate-400 text-[8px] uppercase font-black text-center py-2 transition hover:text-slate-600">Retour au tableau de bord</button>
        </div>`;

    // --- Initialisation de la caméra (ne s'exécute que si le 'return' plus haut n'a pas été déclenché) ---
    const html5QrCode = new Html5Qrcode("reader");
    let isTorchOn = false;
    const qrCodeSuccessCallback = (decodedText) => {
        html5QrCode.stop().then(() => { handleScanSuccess(decodedText); }).catch(err => console.error(err));
    };
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback).then(() => {
        const torchBtn = document.getElementById("torch-button");
        torchBtn.addEventListener("click", () => {
            isTorchOn = !isTorchOn;
            html5QrCode.applyVideoConstraints({ advanced: [{ torch: isTorchOn }] }).catch(e => {});
            torchBtn.innerHTML = isTorchOn ? '<i class="fas fa-lightbulb"></i> Éteindre' : '<i class="fas fa-lightbulb"></i> Allumer';
        });
    }).catch(err => {
        // Gestion d'erreur si la caméra ne démarre pas
        console.error("Erreur caméra:", err);
        container.innerHTML = `<p class="text-red-500 text-center p-10 font-black">Impossible d'accéder à la caméra.</p>`;
    });
}

function handleScanSuccess(id) {
    const beep = document.getElementById("beep-sound");
    if (beep) beep.play();
    if (navigator.vibrate) navigator.vibrate(100);

    const d = appData.demandes.find(x => x.id === id);
    if (d) {
        // 1. Vérifier la date avant d'ajouter
        verifierReinitialisationQuotidienne();

        // 2. Ajouter à l'historique du jour (si pas déjà présent pour éviter les doublons)
        if (!appData.scansDuJour.some(s => s.id === id)) {
            appData.scansDuJour.unshift({
                id: id,
                heure: new Date().toLocaleTimeString([], {hour: '2p', minute: '2p'}),
                technicien: d.demandeurName
            });
            save();
        }

        const resultText = document.getElementById("scan-id-text");
        const resultDiv = document.getElementById("scanner-result");
        if (resultText && resultDiv) {
            resultText.innerText = "BON DÉTECTÉ : " + id;
            resultDiv.classList.remove("hidden");
        }

        setTimeout(() => {
            if (d.status === "PRET" || d.status === "EN ATTENTE GESTIONNAIRE") {
                prepSortie(id); 
            } else {
                alert("STATUT : " + d.status);
                showSection("scanner-physique");
            }
        }, 1000);
    } else {
        alert("QR CODE INCONNU.");
        showSection("scanner-physique");
    }
}
        function addRowEx() {
            const div = document.createElement("div"); div.className = "flex gap-2 items-center art-row-ex bg-slate-50 p-2 rounded-xl border";
            div.innerHTML = `<input type="text" placeholder="DÉSIGNATION" class="w-3/4 border p-2 rounded-lg text-[9px] art-l uppercase bg-white" required /><input type="number" placeholder="QTÉ" class="w-1/4 border p-2 rounded-lg text-[9px] art-q" required min="1" /><button type="button" onclick="this.parentElement.remove()" class="text-red-500 p-2"><i class="fas fa-trash"></i></button>`;
            document.getElementById("excel-items-list").appendChild(div);
        }

        function handleExcelSubmit(e) {
            e.preventDefault();
            const items = [];
            document.querySelectorAll(".art-row-ex").forEach(r => { items.push({ label: r.querySelector(".art-l").value.toUpperCase(), qty: parseInt(r.querySelector(".art-q").value) }); });
            const motifComplet = `[ÉQUIPE: ${document.getElementById("ex-team").value}] CHEF: ${document.getElementById("ex-chef").value} | LIEU/MOTIF: ${document.getElementById("ex-motif").value}`;
            const c = { id: "EXCEL-"+Date.now().toString().slice(-4), demandeurOriginalId: currentUser.id, demandeurName: "COORDINATION (AUTO)", op: "ITC", items, motif: motifComplet.toUpperCase(), status: "EN ATTENTE GESTIONNAIRE", date: new Date().toLocaleDateString() };
            appData.demandes.unshift(c); addNotification(2, `COMMANDE VIA EXCEL : ${c.id}`); save(); alert("COMMANDE ÉMISE."); showSection("cockpit");
        }

        function exportStatsToExcel() {
    const moisNom = new Date().toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
    
    // 1. Préparer les données pour l'onglet Équipes
    const dataEquipes = [["ÉQUIPE", "TOTAL ARTICLES CONSOMMÉS"]];
    const livraisonsMois = appData.demandes.filter(d => d.status === "LIVREE"); // Filtre simplifié pour l'exemple
    
    const statsEquipe = {};
    livraisonsMois.forEach(d => {
        const eq = d.prestataire || "SANS ÉQUIPE";
        const qty = d.items.reduce((sum, i) => sum + i.qty, 0);
        statsEquipe[eq] = (statsEquipe[eq] || 0) + qty;
    });
    Object.entries(statsEquipe).forEach(([eq, qty]) => dataEquipes.push([eq, qty]));

    // 2. Préparer les données pour l'onglet Détails Techniciens
    const dataTechs = [["TECHNICIEN", "PROJET/SITE", "DATE LIVRAISON", "NOMBRE D'ARTICLES"]];
    livraisonsMois.forEach(d => {
        const qty = d.items.reduce((sum, i) => sum + i.qty, 0);
        dataTechs.push([d.demandeurName, d.motif, d.dateLivraison, qty]);
    });

    // 3. Création du classeur Excel
    const wb = XLSX.utils.book_new();
    const ws1 = XLSX.utils.aoa_to_sheet(dataEquipes);
    const ws2 = XLSX.utils.aoa_to_sheet(dataTechs);

    XLSX.utils.book_append_sheet(wb, ws1, "Résumé Équipes");
    XLSX.utils.book_append_sheet(wb, ws2, "Détails Techniciens");

    // 4. Téléchargement du fichier
    XLSX.writeFile(wb, `RAPPORT_CONSO_ITC_${moisNom.toUpperCase()}.xlsx`);
}

        // --- COCKPIT & ALERTES ---
        function renderCockpit(container) {
    // 1. SÉCURITÉ : On définit des listes vides par défaut si les données manquent
    const stock = appData.stock || [];
    const demandes = appData.demandes || [];

    // 2. CALCULS SÉCURISÉS
    const totalStock = stock
        .filter(s => s.op === "ITC")
        .reduce((a, b) => a + (parseInt(b.qty) || 0), 0);
    
    const pending = demandes.filter(d => d.status === "EN ATTENTE GESTIONNAIRE").length;
    
    const alerts = stock.filter(s => s.op === "ITC" && (parseInt(s.qty) || 0) < 5).length;

    let html = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 font-black">
            <div class="bg-indigo-600 text-white p-6 rounded-3xl shadow-lg">
                <p class="text-[8px] opacity-60">STOCK TOTAL ITC</p>
                <p class="text-3xl font-black">${totalStock} U</p>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-lg border-t-4 border-yellow-500">
                <p class="text-[8px] text-slate-400 uppercase font-black">Commandes en attente</p>
                <p class="text-3xl text-slate-800">${pending}</p>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-lg border-t-4 border-red-500">
                <p class="text-[8px] text-slate-400 uppercase font-black tracking-widest">Alertes Rupture</p>
                <p class="text-3xl text-red-600">${alerts}</p>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 italic font-bold">`;

    // 3. AFFICHAGE DES GROUPES PAR OPÉRATEUR
    ["ITC", "OCI-CIC", "MOOV", "MTN"].forEach(key => {
        const group = stock.filter(s => 
            key === "OCI-CIC" ? ["OCI", "CIC", "OCI-CIC"].includes(s.op) : s.op === key
        );

        html += `
            <div class="bg-white p-6 rounded-3xl shadow-xl border-l-8 border-slate-200">
                <h3 class="text-xl font-black mb-6 uppercase text-indigo-900">${key}</h3>
                <div class="space-y-2">
                    ${group.length > 0 ? group.map(m => {
                        let qtyVal = parseInt(m.qty) || 0;
                        let badgeColor = (key === 'ITC' && qtyVal < 5) ? 'text-red-600 bg-red-50' : 'text-indigo-600 bg-indigo-50';
                        
                        return `
                        <div class="flex justify-between p-3 bg-slate-50 rounded-xl border items-center transition hover:bg-white">
                            <span class="w-1/2 truncate uppercase">${m.label}</span>
                            <div class="flex items-center gap-2">
                                <span class="font-black px-3 py-1 rounded-lg text-[8px] ${badgeColor}">
                                    ${key === 'ITC' ? qtyVal + ' U' : 'DISPO'}
                                </span>
                                
                                ${(currentUser.role === 'Gestionnaire' && key === 'ITC') ? 
                                    `<button onclick="ouvrirModifStock('${m.label.replace(/'/g, "\\'")}')" class="text-blue-500 hover:text-blue-700 ml-1">
                                        <i class="fas fa-edit"></i>
                                    </button>` : ''}

                                ${currentUser.role === 'Gestionnaire' ? 
                                    `<button onclick="deleteMaterial('${m.op}','${m.label.replace(/'/g, "\\'")}')" class="text-slate-200 hover:text-red-500 ml-1">
                                        <i class="fas fa-trash"></i>
                                    </button>` : ''}
                            </div>
                        </div>`;
                    }).join("") : '<p class="text-[8px] text-slate-400 opacity-50">Aucun matériel répertorié</p>'}
                </div>
            </div>`;
    });

    html += `</div>`; 
    container.innerHTML = html;
}
        function ouvrirModifStock(label) {
    const item = appData.stock.find(s => s.label === label && s.op === "ITC");
    if (!item) return;

    // Sauvegarde de l'état initial pour l'audit
    const ancienneQty = item.qty;
    const ancienNom = item.label;

    const nouveauNom = prompt("MODIFIER LE NOM DE L'ARTICLE :", item.label);
    if (nouveauNom === null) return; 

    const nouvelleQty = prompt("MODIFIER LA QUANTITÉ EN STOCK :", item.qty);
    if (nouvelleQty === null) return; 

    // Mise à jour
    item.label = nouveauNom.toUpperCase();
    item.qty = parseInt(nouvelleQty) || 0;

    // ALERTE AUDIT POUR LE SUPERVISEUR (ID 1)
    const messageAudit = `ALERTE MODIFICATION STOCK : L'article "${ancienNom}" (${ancienneQty}U) a été renommé en "${item.label}" avec une nouvelle quantité de (${item.qty}U) par le gestionnaire.`;
    addNotification(1, messageAudit);
    
    save();
    showSection("cockpit");
}

        function renderTechMesDemandes(container) {
    // Affiche les bons dès qu'ils sont validés par la coordination
    const myBS = appData.demandes.filter(d => 
        d.demandeurOriginalId === currentUser.id && 
        ["EN ATTENTE GESTIONNAIRE", "PRET", "LIVREE"].includes(d.status)
    );

    container.innerHTML = `
        <div class="bg-white rounded-3xl p-8 shadow-xl italic font-bold">
            <h3 class="border-b-2 mb-6 uppercase text-pink-600 font-black">Mes Bons de Sortie (Disponibles)</h3>
            <div class="grid grid-cols-1 gap-4">
                ${myBS.map(bs => `
                    <div class="bg-slate-50 p-5 rounded-2xl border flex justify-between items-center">
                        <div>
                            <p class="text-indigo-900 font-black">${bs.id}</p>
                            <p class="text-[8px] uppercase text-orange-500">STATUT : ${bs.status.replace(/-/g, " ")}</p>
                            <p class="text-[7px] text-slate-400">PROJET : ${bs.motif}</p>
                        </div>
                        <button onclick="downloadPDF('${bs.id}')" class="bg-indigo-600 text-white px-6 py-3 rounded-xl text-[9px] font-black uppercase">
                            <i class="fas fa-file-pdf mr-2"></i> Générer PDF
                        </button>
                    </div>`).join("")}
                ${myBS.length === 0 ? '<p class="text-center py-10 opacity-30 uppercase">Aucun bon disponible</p>' : ''}
            </div>
        </div>`;
}

function renderTechDemandeForm(container) {
    container.innerHTML = `
        <div class="max-w-xl mx-auto bg-white p-8 rounded-3xl shadow-xl italic font-bold">
            <h3 class="mb-6 uppercase text-indigo-600 border-b-2 pb-2 font-black italic">
                <i class="fas fa-user-edit mr-2"></i> Identification & Besoins
            </h3>
            <form onsubmit="handleTechSubmit(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[8px] text-slate-400 uppercase">Nom du Technicien</label>
                        <input id="t-nom" type="text" value="${currentUser.name}" class="w-full border-2 p-3 rounded-xl text-xs uppercase bg-slate-50 outline-none focus:border-indigo-500" placeholder="VOTRE NOM" required />
                    </div>
                    <div>
                        <label class="text-[8px] text-slate-400 uppercase">Nom de l'équipe</label>
                        <input id="t-equipe" type="text" class="w-full border-2 p-3 rounded-xl text-xs uppercase bg-slate-50 outline-none focus:border-indigo-500" placeholder="EX: ÉQUIPE FIBRE 1" required />
                    </div>
                </div>
                <div>
                    <label class="text-[8px] text-slate-400 uppercase">Lieu & Nom de la tâche (Site)</label>
                    <input id="t-objectif" type="text" class="w-full border-2 p-3 rounded-xl text-xs uppercase bg-slate-50 outline-none focus:border-indigo-500" placeholder="EX: SITE COCODY - INSTALLATION BOX" required />
                </div>
                <div>
                    <label class="text-[8px] text-slate-400 uppercase">Détails matériel & Quantités demandés</label>
                    <textarea id="t-besoin" class="w-full border-2 p-3 rounded-xl text-xs h-32 uppercase bg-slate-50 outline-none focus:border-indigo-500" placeholder="EX: 5X CONNECTEURS, 1X ROUTEUR..." required></textarea>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-4 rounded-2xl text-[10px] uppercase font-black shadow-lg hover:bg-indigo-700 transition">
                    Envoyer à la coordination
                </button>
            </form>
        </div>`;
}

function handleTechSubmit(e) {
    e.preventDefault();
    const d = { 
        id: "T-" + Date.now().toString().slice(-4), 
        technicienId: currentUser.id, // Garde l'ID du compte pour l'archivage
        technicienNom: document.getElementById("t-nom").value.toUpperCase(), // Récupère le nom saisi
        equipe: document.getElementById("t-equipe").value.toUpperCase(),
        besoin: document.getElementById("t-besoin").value.toUpperCase(), 
        objectif: document.getElementById("t-objectif").value.toUpperCase(), 
        statut: "EN ATTENTE COORDINATION", 
        date: new Date().toLocaleDateString() 
    };
    appData.techDemandes.unshift(d); 
    addNotification(7, `BESOIN : ${d.technicienNom} (${d.equipe})`); 
    save(); 
    alert("DEMANDE TRANSMISE À LA COORDINATRICE."); 
    showSection("cockpit");
}
function renderCoordFluxTech(container) {
    const data = appData.techDemandes.filter(d => d.statut === "EN ATTENTE COORDINATION");
    
    container.innerHTML = `
        <div class="bg-white rounded-3xl shadow-xl p-8">
            <h3 class="mb-6 uppercase border-b-2 pb-2 text-orange-500 font-black italic">
                <i class="fas fa-truck-pickup mr-2"></i> Besoins Techniciens en attente
            </h3>
            <div class="space-y-4">
                ${data.map(d => `
                    <div class="bg-slate-50 p-5 rounded-2xl border-2 border-slate-100 flex justify-between items-center transition hover:border-orange-300">
                        <div class="w-2/3">
                            <p class="font-black text-indigo-900 text-[11px]">
                                ${d.technicienNom} 
                                <span class="text-indigo-400 font-medium ml-2">[ÉQUIPE : ${d.equipe || 'N/A'}]</span>
                            </p>
                            
                            <p class="text-[9px] text-pink-600 font-black uppercase mt-1">
                                <i class="fas fa-map-marker-alt mr-1"></i> SITE : ${d.objectif}
                            </p>
                            
                            <div class="mt-2 p-2 bg-white rounded-lg border border-slate-200">
                                <p class="text-[8px] text-slate-400 uppercase mb-1">Matériel & Quantités demandés :</p>
                                <p class="text-[9px] uppercase text-slate-700 leading-tight">${d.besoin}</p>
                            </div>
                            
                            <p class="text-[7px] text-slate-300 mt-2">ÉMIS LE : ${d.date}</p>
                        </div>
                        
                        <div class="text-right">
                            <button onclick="preparerCmd('${d.id}')" class="bg-indigo-600 text-white px-6 py-3 rounded-xl text-[9px] uppercase font-black shadow-md hover:bg-indigo-700 transition">
                                Traiter & Assigner
                            </button>
                        </div>
                    </div>
                `).join("")}
                ${data.length === 0 ? `
                    <div class="py-20 text-center">
                        <i class="fas fa-check-circle text-slate-200 text-5xl mb-4"></i>
                        <p class="text-slate-400 italic uppercase">Aucun nouveau besoin terrain à traiter</p>
                    </div>
                ` : ''}
            </div>
        </div>`;
}

        function preparerCmd(id) {
            const tech = appData.techDemandes.find(x => x.id === id); window._currentTechProcess = tech;
            const container = document.getElementById("app-container");
            container.innerHTML = `<div class="max-w-4xl mx-auto bg-white p-10 rounded-3xl shadow-xl italic font-bold font-black"><h3 class="mb-6 border-b-2 text-pink-600 uppercase">Conversion du besoin</h3><input id="c-motif" type="text" class="w-full border-2 p-3 rounded-xl mb-6 text-xs uppercase bg-slate-50" value="${tech.objectif}" required /><div id="cmd-list" class="space-y-3"></div><button onclick="addRow()" class="text-indigo-600 text-[9px] mt-4 uppercase">+ ARTICLE</button><button onclick="submitCmd()" class="w-full bg-slate-900 text-white py-4 rounded-2xl text-[10px] mt-8 uppercase font-black">Envoyer Magasin</button></div>`;
            addRow();
        }

        function addRow() {
            const div = document.createElement("div"); div.className = "flex gap-2 items-center art-row bg-slate-50 p-2 rounded-xl";
            const stockITC = appData.stock.filter(s => s.op === "ITC");
            div.innerHTML = `<select class="w-3/4 border p-2 rounded-lg text-[9px] art-l uppercase">${stockITC.map(s => `<option value="${s.label}">${s.label} (${s.qty} DISPO)</option>`).join("")}</select><input type="number" placeholder="QTÉ" class="w-1/4 border p-2 rounded-lg text-[9px] art-q" required min="1" />`;
            document.getElementById("cmd-list").appendChild(div);
        }

        function submitCmd() {
    const tech = window._currentTechProcess;
    const items = [];
    document.querySelectorAll(".art-row").forEach(r => {
        const label = r.querySelector(".art-l").value;
        const qty = parseInt(r.querySelector(".art-q").value);
        if(label && qty > 0) items.push({ label, qty });
    });

    const c = { 
        id: "BS-" + Date.now().toString().slice(-4), 
        demandeurOriginalId: tech.technicienId, 
        demandeurName: tech.technicienNom,
        coordinateurNom: currentUser.name, // Nom de la coordinatrice connectée
        prestataire: "ITC / " + (tech.equipe || "TERRAIN"), 
        op: "ITC", 
        items, 
        motif: tech.objectif.toUpperCase(), 
        status: "EN ATTENTE GESTIONNAIRE", // Disponible immédiatement pour le tech
        date: new Date().toLocaleDateString() 
    };
    
    appData.demandes.unshift(c); 
    tech.statut = "VALIDÉ";
    addNotification(tech.technicienId, `VOTRE BON ${c.id} EST PRÊT. TÉLÉCHARGEZ LE PDF.`);
    save(); 
    alert("COMMANDE ENVOYÉE AU MAGASIN ET BON TRANSMIS AU TECHNICIEN."); 
    showSection("cockpit");
}

function renderCoordCreationDirecte(container) {
    container.innerHTML = `
        <div class="max-w-4xl mx-auto bg-white p-10 rounded-3xl shadow-xl italic font-bold font-black">
            <h3 class="mb-6 border-b-2 text-pink-600 uppercase italic">Commande Directe (Manuelle)</h3>
            
            <form onsubmit="handleDirectSubmit(event)" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-[8px] text-slate-400 uppercase">Opérateur Source</label>
                        <select id="d-op" onchange="refreshDirectMaterials()" class="w-full border-2 p-3 rounded-xl text-xs uppercase bg-slate-50 outline-none">
                            <option value="ITC">ITC</option>
                            <option value="OCI-CIC">OCI-CIC</option>
                            <option value="MOOV">MOOV</option>
                            <option value="MTN">MTN</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[8px] text-slate-400 uppercase">Projet / Motif de sortie</label>
                        <input id="d-motif" type="text" class="w-full border-2 p-3 rounded-xl text-xs uppercase bg-slate-50" placeholder="EX: CHANTIER PLATEAU" required />
                    </div>
                </div>

                <div id="direct-items-list" class="space-y-3">
                    </div>

                <button type="button" onclick="addDirectRow()" class="text-indigo-600 text-[9px] uppercase font-black border-b-2 border-indigo-50 mt-4">
                    <i class="fas fa-plus mr-1"></i> Ajouter un article
                </button>

                <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl text-[10px] mt-8 uppercase font-black shadow-lg hover:bg-black transition">
                    Confirmer la commande
                </button>
            </form>
        </div>`;
    
    // On ajoute une première ligne vide au démarrage
    addDirectRow();
}

function addDirectRow() {
    const div = document.createElement("div");
    div.className = "flex flex-col md:flex-row gap-2 items-end direct-row bg-slate-50 p-3 rounded-xl border transition hover:border-pink-200";
    
    div.innerHTML = `
        <div class="flex-1 w-full">
            <label class="text-[7px] text-slate-400 uppercase">Catégorie</label>
            <select class="w-full border p-2 rounded-lg text-[9px] art-type uppercase bg-white" required>
                <option value="" disabled selected>-- TYPE --</option>
                <option value="MATÉRIELS POUR CONSTRUCTION D'ARTÈRES AÉRIENNES">MATÉRIELS POUR CONSTRUCTION D'ARTÈRES AÉRIENNES</option>
                <option value="CABLES FIBRES OPTIQUES SOUTERRAINS">CÂBLES FIBRES OPTIQUES SOUTERRAINS</option>
                <option value="CABLES FIBRES OPTIQUES AÉRIENS">CÂBLES FIBRES OPTIQUES AÉRIENS</option>
                <option value="MATÉRIELS POUR CONSTRUCTION DE LIGNE D'ABONNÉS">MATÉRIELS POUR CONSTRUCTION DE LIGNE D'ABONNÉS</option>
                <option value="MATÉRIELS DE PROTECTION ET DE RACCORDEMENT">MATÉRIELS DE PROTECTION ET DE RACCORDEMENT</option>
                <option value="MATÉRIELS DE PROTECTION ET DE RACCORDEMENT FO">MATÉRIELS DE PROTECTION ET DE RACCORDEMENT FO</option>
                <option value="CONNECTIQUES FO">CONNECTIQUES FO</option>
                <option value="MATÉRIELS D'ÉTIQUETAGE">MATÉRIELS D'ÉTIQUETAGE</option>
                <option value="MATÉRIELS GÉNIE CIVIL (GC)">MATÉRIELS GÉNIE CIVIL (GC)</option>
            </select>
        </div>

        <div class="flex-1 w-full">
            <label class="text-[7px] text-slate-400 uppercase">Désignation</label>
            <input type="text" placeholder="NOM DE L'ARTICLE" class="w-full border p-2 rounded-lg text-[9px] art-l uppercase bg-white" required />
        </div>

        <div class="w-24">
            <label class="text-[7px] text-slate-400 uppercase">Quantité</label>
            <input type="number" placeholder="QTÉ" class="w-full border p-2 rounded-lg text-[9px] art-q" required min="1" />
        </div>

        <button type="button" onclick="this.parentElement.remove()" class="text-red-500 p-2 hover:bg-red-50 rounded-lg transition">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    document.getElementById("direct-items-list").appendChild(div);
}

        function refreshDirectMaterials() { document.getElementById("direct-items-list").innerHTML = ""; addDirectRow(); }

        function handleDirectSubmit(e) {
            e.preventDefault();
            const items = []; document.querySelectorAll(".direct-row").forEach(r => { items.push({ label: r.querySelector(".art-l").value, qty: parseInt(r.querySelector(".art-q").value) }); });
            const c = { id: "CMD-D-"+Date.now().toString().slice(-4), demandeurOriginalId: currentUser.id, demandeurName: "COORDINATION", op: document.getElementById("d-op").value, items, motif: document.getElementById("d-motif").value.toUpperCase(), status: "EN ATTENTE GESTIONNAIRE", date: new Date().toLocaleDateString() };
            appData.demandes.unshift(c); addNotification(2, `COMMANDE DIRECTE : ${c.id}`); save(); alert("TRANSMIS."); showSection("cockpit");
        }

        // --- RETOURS TERRAIN ---
        function renderRetourForm(container) {
            container.innerHTML = `<div class="max-w-xl mx-auto bg-white p-10 rounded-3xl shadow-xl font-bold italic font-black"><h3 class="mb-6 uppercase text-orange-500 border-b-2 pb-2">Déclarer un Retour</h3><form onsubmit="handleRetourSubmit(event)" class="space-y-4"><input id="ret-label" type="text" placeholder="MATÉRIEL RENDU" class="w-full border-2 p-3 rounded-xl text-xs uppercase bg-slate-50" required /><div class="grid grid-cols-2 gap-4"><input id="ret-qty" type="number" placeholder="QTÉ" class="w-full border-2 p-3 rounded-xl text-xs" required min="1" /><select id="ret-etat" class="w-full border-2 p-3 rounded-xl text-xs uppercase bg-slate-100"><option value="NEUF">NEUF</option><option value="DÉFECTUEUX">DÉFECTUEUX</option></select></div><textarea id="ret-motif" placeholder="MOTIF DU RETOUR..." class="w-full border-2 p-3 rounded-xl text-xs h-24 uppercase bg-slate-50" required></textarea><button type="submit" class="w-full bg-orange-500 text-white py-4 rounded-2xl text-[10px] uppercase font-black">Valider Retour</button></form></div>`;
        }

        function handleRetourSubmit(e) {
            e.preventDefault();
            const r = { id: "RET-"+Date.now().toString().slice(-4), techName: currentUser.name, label: document.getElementById("ret-label").value.toUpperCase(), qty: parseInt(document.getElementById("ret-qty").value), etat: document.getElementById("ret-etat").value, motif: document.getElementById("ret-motif").value.toUpperCase(), date: new Date().toLocaleDateString(), status: "EN ATTENTE" };
            appData.retours.unshift(r); addNotification(2, `RETOUR : ${r.techName}`); save(); alert("RETOUR ENREGISTRÉ."); showSection("cockpit");
        }

        // --- GESTION MAGASIN ---
        function renderDemandesGestionnaire(container) {
    // 1. SÉCURITÉ : On vérifie que appData existe et on crée une liste vide si demandes est absent
    if (!appData) return;
    const toutesLesDemandes = appData.demandes || [];

    // 2. FILTRAGE : On récupère uniquement les bons en attente
    const data = toutesLesDemandes.filter(d => d.status === "EN ATTENTE GESTIONNAIRE");

    // 3. GÉNÉRATION DE L'INTERFACE
    container.innerHTML = `
        <div class="bg-white rounded-3xl p-8 shadow-xl font-bold italic font-black">
            <h3 class="border-b-2 mb-6 uppercase text-yellow-600 font-black italic">
                Préparation Commandes
            </h3>
            
            <div class="space-y-4">
                ${data.map(d => `
                    <div class="bg-slate-50 p-4 rounded-2xl flex justify-between items-center border hover:border-yellow-200 transition">
                        <div>
                            <p class="font-black text-indigo-900">${d.id} | ${d.demandeurName}</p>
                            <p class="text-[7px] text-orange-500 uppercase italic">MOTIF : ${d.motif || 'NON PRÉCISÉ'}</p>
                        </div>
                        <button onclick="prepSortie('${d.id}')" class="bg-indigo-600 text-white px-5 py-2 rounded-xl text-[9px] font-black uppercase shadow hover:bg-indigo-700 transition">
                            Réserver
                        </button>
                    </div>
                `).join("")}
                
                ${data.length === 0 ? `
                    <div class="text-center py-10">
                        <i class="fas fa-inbox text-slate-200 text-3xl mb-3"></i>
                        <p class="opacity-30 uppercase text-[10px]">Aucune commande en attente de préparation</p>
                    </div>
                ` : ''}
            </div>
        </div>`;
}

        function prepSortie(id) { const d = appData.demandes.find(x => x.id === id); d.status = "PRET"; save(); showSection("livraison"); }

        function renderLivraisonForm(container) {
    const demandes = appData.demandes || []; // Gilet de sauvetage
    const aLivrer = demandes.filter(d => d.status === "PREPAREE");
    
    container.innerHTML = `
        <div class="bg-white p-8 rounded-3xl shadow-xl italic font-black">
            <h3 class="text-green-600 border-b-2 mb-6 uppercase">Sortie Physique (Scanner)</h3>
            <div class="space-y-4">
                ${aLivrer.map(d => `
                    <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border">
                        <span class="text-xs">${d.id} - ${d.demandeurName}</span>
                        <button onclick="validerLivraison('${d.id}')" class="bg-green-600 text-white px-4 py-2 rounded-lg text-[9px] uppercase">Confirmer Sortie</button>
                    </div>
                `).join("")}
                ${aLivrer.length === 0 ? '<p class="text-center opacity-30 py-5">AUCUN BON PRÊT</p>' : ''}
            </div>
        </div>`;
}

        function finalSortie(id) {
            const d = appData.demandes.find(x => x.id === id);
            let stockInsuffisant = false;
            d.items.forEach(i => { const s = appData.stock.find(st => st.label === i.label && st.op === d.op); if (!s || s.qty < i.qty) stockInsuffisant = true; });
            if (stockInsuffisant) return alert("STOCK INSUFFISANT !");
            d.items.forEach(i => { const s = appData.stock.find(st => st.label === i.label && st.op === d.op); if (s) s.qty -= i.qty; });
            d.status = "LIVREE"; d.dateLivraison = new Date().toLocaleDateString();
            addNotification(1, `AUDIT : SORTIE VALIDÉE (${d.id})`);
            addNotification(d.demandeurOriginalId, `VOTRE MATÉRIEL EST DISPONIBLE (${d.id}).`);
            save(); alert("TERMINÉ."); showSection("cockpit");
        }

        function renderGestionRetours(container) {
    const retours = appData.retours || []; // Sécurité
    const enAttente = retours.filter(r => r.status === "EN ATTENTE");

    container.innerHTML = `
        <div class="bg-white p-8 rounded-3xl shadow-xl italic font-black">
            <h3 class="text-orange-600 border-b-2 mb-6 uppercase">Gestion des Retours Chantier</h3>
            <div class="space-y-4">
                ${enAttente.map(r => `...`).join("")}
                ${enAttente.length === 0 ? '<p class="text-center opacity-30 py-5 font-black">AUCUN RETOUR À TRAITER</p>' : ''}
            </div>
        </div>`;
}

        function validerRetour(id) {
            const r = appData.retours.find(x => x.id === id);
            if (r.etat === "NEUF") {
                const s = appData.stock.find(st => st.label === r.label && st.op === "ITC");
                if (s) s.qty += r.qty; else appData.stock.push({ op: "ITC", label: r.label, qty: r.qty, type: "RETOUR" });
            }
            r.status = "VALIDÉ"; addNotification(1, `AUDIT : RETOUR RÉINTÉGRÉ (${r.label})`); save(); alert("STOCK À JOUR."); showSection("gestion-retours");
        }

        // --- AUTRES ---
        function renderReceptionForm(container) {
    container.innerHTML = `
        <div class="max-w-xl mx-auto bg-white p-10 rounded-3xl shadow-xl font-bold italic font-black">
            <h3 class="mb-8 uppercase border-b-2 text-indigo-600 italic">Mise en Stock Matériel</h3>
            
            <form onsubmit="handleRec(event)" class="space-y-5">
                <div>
                    <label class="text-[8px] text-slate-400 uppercase ml-1">Opérateur</label>
                    <select id="r-op" onchange="toggleQtyField(this.value)" class="w-full border-2 p-3 rounded-xl uppercase text-xs bg-white outline-none focus:border-indigo-500">
                        <option value="ITC">ITC</option>
                        <option value="OCI-CIC">OCI-CIC</option>
                        <option value="MOOV">MOOV</option>
                        <option value="MTN">MTN</option>
                    </select>
                </div>

                <div>
                    <label class="text-[8px] text-slate-400 uppercase ml-1">Type de Matériel</label>
                    <select id="r-type" class="w-full border-2 p-3 rounded-xl text-xs uppercase bg-slate-50 outline-none focus:border-indigo-500" required>
                        <option value="" disabled selected>-- CHOISIR UN TYPE --</option>
                        <option value="MATÉRIELS POUR CONSTRUCTION D'ARTÈRES AÉRIENNES">MATÉRIELS POUR CONSTRUCTION D'ARTÈRES AÉRIENNES</option>
                        <option value="CABLES FIBRES OPTIQUES SOUTERRAINS">CÂBLES FIBRES OPTIQUES SOUTERRAINS</option>
                        <option value="CABLES FIBRES OPTIQUES AÉRIENS">CÂBLES FIBRES OPTIQUES AÉRIENS</option>
                        <option value="MATÉRIELS POUR CONSTRUCTION DE LIGNE D'ABONNÉS">MATÉRIELS POUR CONSTRUCTION DE LIGNE D'ABONNÉS</option>
                        <option value="MATÉRIELS DE PROTECTION ET DE RACCORDEMENT">MATÉRIELS DE PROTECTION ET DE RACCORDEMENT</option>
                        <option value="MATÉRIELS DE PROTECTION ET DE RACCORDEMENT FO">MATÉRIELS DE PROTECTION ET DE RACCORDEMENT FO</option>
                        <option value="CONNECTIQUES FO">CONNECTIQUES FO</option>
                        <option value="MATÉRIELS D'ÉTIQUETAGE">MATÉRIELS D'ÉTIQUETAGE</option>
                        <option value="MATÉRIELS GÉNIE CIVIL (GC)">MATÉRIELS GÉNIE CIVIL (GC)</option>
                    </select>
                </div>

                <div>
                    <label class="text-[8px] text-slate-400 uppercase ml-1">Désignation</label>
                    <input id="r-mat" type="text" placeholder="NOM DE L'ARTICLE" class="w-full border-2 p-3 rounded-xl text-xs uppercase bg-slate-50 outline-none focus:border-indigo-500" required />
                </div>

                <div id="qty-container">
                    <label class="text-[8px] text-slate-400 uppercase ml-1">Quantité</label>
                    <input id="r-qty" type="number" class="w-full border-2 p-3 rounded-xl text-xs bg-slate-50 outline-none focus:border-indigo-500" placeholder="NOMBRE D'UNITÉS" />
                </div>

                <button type="submit" class="w-full bg-slate-900 text-white py-4 rounded-2xl text-[10px] uppercase font-black transition hover:bg-black shadow-lg">
                    Confirmer l'Entrée
                </button>
            </form>
        </div>`;
    
    // On réinitialise l'affichage de la quantité selon la sélection par défaut (ITC)
    toggleQtyField('ITC');
}

        function handleRec(e) { e.preventDefault(); const mat = { op: document.getElementById("r-op").value, label: document.getElementById("r-mat").value.toUpperCase(), qty: parseInt(document.getElementById("r-qty").value) || 0, type: document.getElementById("r-type").value.toUpperCase() }; const existing = appData.stock.find(s => s.op === mat.op && s.label === mat.label); if(existing && mat.op === 'ITC') existing.qty += mat.qty; else appData.stock.push(mat); addNotification(1, `TRAFIC : ENTRÉE STOCK (${mat.label})`); save(); alert("ENREGISTRÉ."); showSection("cockpit"); }
        function toggleQtyField(v) { document.getElementById('qty-container').style.display = (v === 'ITC' ? 'block' : 'none'); }

        function renderStock(operateur, container) {
    const stock = appData.stock || []; // Sécurité
    const items = stock.filter(s => s.op === operateur);

    container.innerHTML = `
        <div class="bg-white p-8 rounded-3xl shadow-xl italic font-black">
            <h3 class="text-indigo-600 border-b-2 mb-6 uppercase">Détail Stock : ${operateur}</h3>
            <div class="grid grid-cols-1 gap-3">
                ${items.map(m => `
                    <div class="flex justify-between p-3 bg-slate-50 rounded-xl border">
                        <span class="text-xs uppercase">${m.label}</span>
                        <span class="font-black text-indigo-600">${m.qty} U</span>
                    </div>
                `).join("")}
                ${items.length === 0 ? '<p class="text-center py-10 opacity-30">STOCKS VIDES</p>' : ''}
            </div>
        </div>`;
}

        function renderTraficAudit(container) {
            const notifs = appData.notifications.filter(n => n.userId === 1);
            container.innerHTML = `<div class="bg-white rounded-3xl p-8 shadow-xl font-bold italic uppercase"><h3 class="border-b-2 mb-6 text-blue-600 font-black tracking-tighter italic">Journal d'Audit</h3><div class="space-y-3">${notifs.map(n => `<div class="bg-slate-50 p-4 rounded-xl border-l-4 border-indigo-400"><p class="text-[9px] text-slate-800">${n.message}</p><p class="text-[7px] text-slate-400 mt-2">${n.date}</p></div>`).join("")}</div></div>`;
        }



        async function downloadPDF(id) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const d = appData.demandes.find(x => x.id === id);
    
    // Nettoyer et générer le QR Code en mémoire
    const qrContainer = document.getElementById("qrcode-temp");
    qrContainer.innerHTML = "";
    new QRCode(qrContainer, { text: d.id, width: 100, height: 100 });

    // Laisser 500ms au navigateur pour dessiner le QR Code
    setTimeout(() => {
        try {
            const qrCanvas = qrContainer.querySelector("canvas");
            const qrImage = qrCanvas.toDataURL("image/jpeg");

            // Design du PDF
            doc.addImage("logo-ITC-NW-01-fond-blanc-01.jpg", 'JPEG', 15, 10, 40, 20);
            doc.addImage(qrImage, 'JPEG', 165, 10, 25, 25);
            
            doc.setFontSize(16);
            doc.text("BON DE SORTIE MATÉRIEL", 105, 22, { align: "center" });

            doc.autoTable({
                startY: 85,
                head: [['DÉSIGNATION', 'DEMANDÉ', 'REÇU']],
                body: d.items.map(i => [i.label, i.qty, d.status === "LIVREE" ? i.qty : "___"]),
                theme: 'grid',
                headStyles: { fillColor: [102, 34, 119] }
            });

            doc.save(`BS_ITC_${d.id}.pdf`);
        } catch (e) {
            alert("Erreur PDF : vérifiez que le logo est accessible.");
        }
    }, 500);
}
function markNotificationsAsRead() {
    if (!appData || !appData.notifications) return; // Sécurité totale

    appData.notifications.forEach(n => {
        if (n.userId === currentUser.id) n.lu = true;
    });
    save();
}function markNotificationsAsRead() {
    if (!appData || !appData.notifications) return; // Sécurité totale

    appData.notifications.forEach(n => {
        if (n.userId === currentUser.id) n.lu = true;
    });
    save();
    updateNotifications;
}
        function addNotification(u, m) { if(!appData.notifications) appData.notifications = []; appData.notifications.unshift({ userId: u, message: m, lu: false, date: new Date().toLocaleString() }); save(); updateNotifications(); }
        function updateNotifications() {
    // 1. Sécurité : Si l'utilisateur n'est pas là ou si les données ne sont pas chargées
    if (!currentUser || !appData) return;

    // 2. Sécurité CRUCIALE : On utilise une liste vide [] si 'notifications' est absent
    const notifications = appData.notifications || [];
    
    // 3. Calcul du nombre de notifs non lues pour cet utilisateur précis
    const count = notifications.filter(n => n.userId === currentUser.id && !n.lu).length;

    // 4. Mise à jour des pastilles (badges) dans l'interface
    const badgeIds = ["notif-coord", "notif-tech", "notif-superviseur", "notif-gest-coord"];
    
    badgeIds.forEach(id => { 
        const el = document.getElementById(id); 
        if (el) { 
            el.innerText = count; 
            // On affiche le badge seulement si count > 0, sinon on le cache
            el.classList.toggle("hidden", count === 0); 
        }
    });
}
        function deleteMaterial(op, label) {
    if (!confirm("ATTENTION : VOULEZ-VOUS SUPPRIMER DÉFINITIVEMENT CET ARTICLE DU STOCK ?")) return;
    
    const itemASupprimer = appData.stock.find(s => s.op === op && s.label === label);
    const qteAuMomentSuppr = itemASupprimer ? itemASupprimer.qty : "Inconnue";

    appData.stock = appData.stock.filter(s => !(s.op === op && s.label === label));

    // ALERTE CRITIQUE POUR LE SUPERVISEUR (ID 1)
    const messageAudit = `ALERTE SUPPRESSION CRITIQUE : Le gestionnaire a supprimé l'article "${label}" de l'opérateur ${op}. (Quantité au moment de la suppression : ${qteAuMomentSuppr}U)`;
    addNotification(1, messageAudit);

    save();
    showSection("cockpit");
}

        // INITIALISATION
        if (appData.currentUserId) {
            currentUser = appData.users.find(u => u.id === appData.currentUserId);
            if (currentUser) {
                document.getElementById("login-screen").classList.add("hidden");
                document.getElementById("main-app").classList.remove("hidden");
                updateMenuVisibility(); updateUserInfo(); updateNotifications();
                showSection(currentUser.role === 'Technicien' ? "tech-nouvelle-demande" : "cockpit");
            }
        }

        firebase.auth().onAuthStateChanged((user) => {
    if (user) {
        // Un utilisateur est présent dans le cache Firebase
        const userProfile = appData.users.find(u => u.email === user.email);
        if (userProfile) {
            currentUser = userProfile;
            document.getElementById("login-screen").classList.add("hidden");
            document.getElementById("main-app").classList.remove("hidden");
            updateMenuVisibility();
            updateUserInfo();
            updateNotifications();
            // On n'appelle showSection("cockpit") que si on est sur l'écran de login
            if (document.getElementById("app-container").innerHTML === "") {
                showSection("cockpit");
            }
        }
    } else {
        // AUCUN utilisateur : On force l'affichage du login
        document.getElementById("login-screen").classList.remove("hidden");
        document.getElementById("main-app").classList.add("hidden");
        currentUser = null;
    }
});
    </script>
</body>
</html>